<div class="registar-editar-pagos">
  @if(detallePagoCuota){
    <div class="modal__header">
      <div class="modal_header__content">
        <div class="cfe-titulo-1">Seguimiento de Cuota N° {{detallePagoCuota.cuota}}</div>
      </div>
      <div class="flex">
        <p-button (click)="ref.close()" icon="pi pi-times" styleClass="p-button-rounded text-color p-button-text"
          onKeyPress></p-button>
      </div>
    </div>
    <div class="flex titulo-acta">
      <div class="cfe-titulo-1">Acta</div>
      <span class="reparacion">{{detallePagoCuota.codReparacionCivil}}</span>
    </div>
    <div class="detalle-cuota mb-2">
        <div class="item">
          <span class="titulo">Monto total de la cuota</span>
          <span class="valor">{{detallePagoCuota.montoCuota | solPeruano}}</span>
        </div>
        <div class="item">
          <span class="titulo">Monto pagado</span>
          <span class="valor">{{detallePagoCuota.montoPagado | solPeruano}}</span>
        </div>
        <div class="item">
          <span class="titulo">Monto pendiente</span>
          <span class="valor">{{detallePagoCuota.montoPendiente | solPeruano}}</span>
        </div>
        <div class="item">
          <span class="titulo">Fecha de vencimiento</span>
          <span class="valor">{{detallePagoCuota.fechaVencimiento}}</span>
        </div>
      </div>
    @if(!modoLectura){ 
    <form class="form-pagos" 
         [class.editando]="editando" 
         [formGroup]="formPago"
         (ngSubmit)="guardarPago()">
      <div class="cfe-titulo-1">{{editando?'Editar pago':'Registrar pago'}}:</div>
      @if(textoValidacion){
        <div class="mb-2 mt-2">
            <mensaje-generico [closable]="true" 
                                  (cerrado)="textoValidacion = null"
                                  [tipoAlerta]="'error'"
                                  [titulo]="textoValidacion"/>
        </div>
      }
      <div class="grid mt-1">
        <div class="col-12 md:col-4">
            <label for="monto" class="p-label-bottom font-bold text-sm">Monto depositado S/</label>
            <input pInputText
                    digitOnly
                    type="text"
                    (blur)="formatearMonto()"
                    [decimal]="true"
                    [decimalSeparator]="'.'"
                    class="p-inputtext-md w-full"
                    placeholder="Ingrese monto depositado"
                    formControlName="monto"/>
        </div>
        <div class="col-12 md:col-4">
            <label for="recibo" class="p-label-bottom font-bold text-sm">Número de recibo
                <i onKeyPress (click)="mostrarGuiaComprobante = true" 
              class="pi pi-info-circle font-bold cursor-pointer icon-info"></i>
            </label>
            <input pInputText
                    type="text"
                    class="p-inputtext-md w-full"
                    placeholder="Ingrese número de recibo"
                    (keypress)="validOnlyAlphanumeric($event)"
                    (paste)="validOnlyAlphanumericOnPaste($event)"
                    (drop)="validOnlyAlphanumericDrop($event)"
                    [maxlength]="20"
                    formControlName="recibo"/>
        </div>
        <div class="col-12 md:col-4">
            <label for="fechaPago" class="p-label-bottom font-bold text-sm">Fecha de pago</label>
            <p-calendar dateMask
                        dateFormat="dd/mm/yy"
                        class="p-inputtext-md cfe-calendar h-40"
                        [showIcon]="true"
                        icon="cfe-calendar-icon"
                        placeholder="dd/mm/aaaa"
                        [maxDate]="fechaActual"
                        appendTo="body"
                        formControlName="fechaPago"/>
        </div>
      </div>
      <div class="grid">
        <div class="col-12 md:col-12">
            <div class="w-full pb-1">
                <label for="observacion" class="font-bold text-sm">Observaciones (opcional)</label>
            </div>
            <div class="w-full">
                <textarea maxlength="1000"
                          formControlName="observacion"
                          pInputTextarea id="observaciones"
                          class="w-full p-inputtextarea p-inputtext p-component p-element"
                          rows="2"
                          [maxlength]="1000"
                          placeholder="Ingrese la observación"></textarea>
                <small
                class="block text-right mt-1"
                [ngClass]="{ 'p-error': counterReportChar('observacion') > 1000 }">
                {{ counterReportChar('observacion') }}/1000 carácteres
              </small>
            </div>
        </div>
      </div>
      <div class="flex justify-content-between align-items-center mt-1">
        <div class="flex justify-content-center align-items-center">
          <button type="button"
            (click)="fileInput.click()"
            class="cfe-boton-secondary cfe-boton-lg inline w-full md:w-auto family-poppin-bold">
            <div class="flex">
                <fn-icon [ico]="iconUtil.obtenerIcono('iAttach')"
                height="1.5rem"></fn-icon>
                <span>Subir comprobante (opcional)</span>
            </div>
          </button>        
          @if(comprobanteSeleccionado){
            <div class="ml-2 mt-1">
              <img [src]="icono('check-circle')" alt="guardado" class="pr-2 h-2rem">
            </div>
          }
        </div>
        <input #fileInput 
                type="file"
                (change)="seleccionarComprobante($event, fileInput)"
                accept=".pdf, .jpg, .jpeg, .png"
                hidden>     
        <div class="flex">
          @if(editando){
            <button type="button"
            (click)="limpiarFormulario()"
            class="cfe-boton-secondary cfe-boton-lg inline ml-0 md:ml-2 mt-1 md:mt-0 md:w-auto family-poppin-bold">Cancelar edición</button>
          }   
          <button type="submit"
          class="cfe-boton-primary cfe-boton-lg inline ml-0 md:ml-2 mt-1 md:mt-0 md:w-auto family-poppin-bold">Guardar</button>
        </div>        
      </div>
      @if(comprobanteSeleccionado){
        <div class="text-center mt-1 limpiar-comprobante">
          <span onKeyPress (click)="resetearInputComprobante(fileInput)">Limpiar</span>
        </div>
      }
    </form>
    } 
    <div class="tabla-pagos" [class.editando-margin]="modoLectura">
      <p-table [value]="detallePagoCuota.listaPagos"
            responsiveLayout="stack"
            [paginator]="true"
            dataKey="idCuotas"
            [paginator]="true"
            [rows]="5"
            [showCurrentPageReport]="true"
            [tableStyle]="{ 'min-width': '50rem' }"
            currentPageReportTemplate="{first} de {last} registros">
      <ng-template pTemplate="header">
          <tr>
              <th scope>#</th>
              <th class="text-right" scope>Monto</th>
              <th class="text-left" scope>N° recibo</th>
              <th class="text-left" scope>F. Depósito</th>
              <th class="text-left" scope>F. Registro</th>
              <th class="text-left" scope>Observaciones</th>
              <th scope>Opciones</th>
          </tr>
      </ng-template>
      <ng-template pTemplate="body" let-pago let-rowIndex="rowIndex">
          <tr [class.editando]="editando && formPago.get('idSeguiCuota')?.value === pago.idSeguiCuota">
              <td>
                {{ rowIndex + 1}}
              </td>
              <td class="text-right">
                {{ pago.monto | solPeruano }}
              </td>
              <td class="text-left">
                {{ pago.recibo  }}
              </td>
              <td class="text-left">
                {{ pago.fechaPago}}
              </td>
              <td class="text-left">
                {{ pago.fechaCreacion}}
              </td>
              <td class="text-left">
                {{ pago.observaciones}}
              </td>
              <td>
                <div class="flex">
                  <fn-icon
                    class="ml-1 mt-1 cursor-pointer"
                    [ico]="iconUtil.obtenerIcono('iEye')" 
                    height="1.7rem">
                  </fn-icon>
                  @if(!modoLectura){
                    <fn-icon
                    class="ml-1 mt-1 cursor-pointer"
                    [ico]="iconUtil.obtenerIcono('iEdit')"
                    (click)="editarPago(pago)"
                    height="1.5rem"
                    onKeyPress
                ></fn-icon>
                  <fn-icon
                    class="cursor-pointer"
                    (click)="eliminarPago(pago.idSeguiCuota)"
                    [ico]="iconUtil.obtenerIcono('iTrash')"
                    height="2.1rem"
                    onKeyPress>
                  </fn-icon>
                  }
                </div>
              </td>
          </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
          <tr>
              <td colspan="7">
                  <div class="text-center">No se han registrado pagos</div>
              </td>
          </tr>
      </ng-template>
      </p-table>
    </div>
  }
  <div class="footer-pagos flex justify-content-center align-items-center gap-3 mt-1">
    <button (click)="ref.close()"
            type="button"
            class="cfe-boton-secondary cfe-boton-lg inline w-full md:w-auto family-poppin-bold">
            {{modoLectura ? 'Cerrar': 'Aceptar'}}
            </button>
  </div>
</div>
<p-dialog 
    [(visible)]="mostrarGuiaComprobante"
    [modal]="true"
    [showHeader]="false"
    [closable]="false"
    [dismissableMask]="true" 
    styleClass="guia-comprobante-dialog"
>
    <app-encabezado-modal
        titulo="<i class='pi pi-info-circle font-bold icon-info-titulo'></i>¿Dónde ubicar el número de recibo?"
        [tituloSinEtiquetaCaso]="true"
        [sinReferencia]="true"
        [alCerrarModal]="cerrarModalGuiaComprobante"
        tituloSize="1.3rem"
    />
    <ng-template pTemplate="content">
        @if ( mostrarGuiaComprobante ) {
            <ng-container>
                <div class="dialog-content">
                   <div>
                    <img class="w-full h-full" [src]="guiaComprobante" alt="Guia de comprobante de pago"  />
                   </div>
                   <div class="w-full text-center font-bold">
                    Constancia de depósito judicial electrónico
                   </div>
                </div>
                <div class="flex justify-content-center align-items-center mt-5">
                  <button (click)="cerrarModalGuiaComprobante()"
                          type="button"
                          class="cfe-boton-secondary cfe-boton-m inline w-full md:w-auto family-poppin-bold">
                          Salir</button>
                </div>
            </ng-container>
        }
    </ng-template>
</p-dialog>